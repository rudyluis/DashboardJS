<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <!-- En el <head>, antes del CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
</head>
<body class="jumbotron " style="background-color: #dee2e6;">
  <nav id="mainNavbar" class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm ">
    <div class="container-fluid justify-content-between">
      <h1 class="navbar-brand mb-0 h3">Dashboard de Datos Tecnol√≥gicos</h1>
      <button id="toggleTheme" class="btn btn-outline-dark"> Modo Oscuro üåô</button>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="card">
      <!-- Filtros -->
      <details class="mb-4">
        <summary class="h5 text-primary" style="cursor: pointer;">üéõÔ∏è Filtros de visualizaci√≥n</summary>

        <div class="row mb-4">
          <div class="col-md-3">
            <label for="filterPais" class="form-label">Filtrar por pa√≠s:</label>
            <select id="filterPais" class="form-select">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filterCiudad" class="form-label">Filtrar por ciudad:</label>
            <select id="filterCiudad" class="form-select">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filterAnio" class="form-label">Filtrar por a√±o:</label>
            <select id="filterAnio" class="form-select">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filterCategoria" class="form-label">Filtrar por categor√≠a:</label>
            <select id="filterCategoria" class="form-select">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
      </details>

      <details class="mb-4">
        <summary class="h5 text-primary" style="cursor: pointer;">üìä Ver tabla de datos</summary>
        <div class="mt-3 table-responsive">
          <table id="tablaDatos" class="table table-striped" style="width:100%">
            <thead>
              <tr>
                <th>Orden</th>
                <th>A√±o</th>
                <th>Mes</th>
                <th>D√≠a</th>
                <th>Fecha</th>
                <th>Pa√≠s</th>
                <th>Ciudad</th>
                <th>Categor√≠a</th>
                <th>Producto</th>
                <th>Precio</th>
                <th>Util %</th>
                <th>Cantidad</th>
                <th>Total</th>
                <th>Utilidad</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>


      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="graficoTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab1-tab" data-bs-toggle="tab" data-bs-target="#tab1" type="button"
            role="tab">Por Pa√≠s y Categor√≠a</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab2-tab" data-bs-toggle="tab" data-bs-target="#tab2" type="button"
            role="tab">Tendencia por Fecha</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3" type="button"
            role="tab">Radar y Doughnut</button>
        </li>
      </ul>

      <div class="tab-content" id="graficoTabsContent">
        <!-- Gr√°ficos Pa√≠s y Categor√≠a -->
        <div class="tab-pane fade show active" id="tab1" role="tabpanel">
          <div class="row g-4">
            <div class="col-md-6">
              <canvas id="ventasPorPais"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="ventasPorCategoria"></canvas>
            </div>
          </div>
        </div>

        <!-- Gr√°fico L√≠nea por Fecha -->
        <div class="tab-pane fade" id="tab2" role="tabpanel">
          <div class="row mt-4">
            <div class="col">
              <canvas id="ventasPorFecha"></canvas>
            </div>
          </div>
        </div>

        <!-- Radar y Doughnut -->
        <div class="tab-pane fade" id="tab3" role="tabpanel">
          <div class="row g-4 mt-3">
            <div class="col-md-6">
              <canvas id="graficoRadar"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="graficoDoughnut"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <script>
    const csvUrl = "https://raw.githubusercontent.com/rudyluis/PROGDAEM/refs/heads/main/Dashboard/DatosTecnologicos.csv";
    let allData = [];

    $(document).ready(function () {
      $.ajax({
        url: csvUrl,
        dataType: "text",
        success: function (data) {
          const parsed = Papa.parse(data, { header: true });
          allData = parsed.data.filter(d => d.pais);
          popularFiltros();
          aplicarFiltrosYGraficos();
        }
      });

      //$('#filterPais, #filterCiudad, #filterAnio, #filterCategoria').on('change', aplicarFiltrosYGraficos);

      $('#filterPais, #filterCiudad, #filterAnio, #filterCategoria').on('change', function () {
        popularFiltros();        // actualizar opciones seg√∫n selecci√≥n
        aplicarFiltrosYGraficos(); // actualizar datos mostrados
      });
    });

    /*function popularFiltros() {
      const unique = (arr, key) => [...new Set(arr.map(d => d[key]).filter(Boolean))].sort();
      unique(allData, 'pais').forEach(v => $('#filterPais').append(`<option value="${v}">${v}</option>`));
      unique(allData, 'ciudad').forEach(v => $('#filterCiudad').append(`<option value="${v}">${v}</option>`));
      unique(allData, 'anio').forEach(v => $('#filterAnio').append(`<option value="${v}">${v}</option>`));
      unique(allData, 'categor√≠a').forEach(v => $('#filterCategoria').append(`<option value="${v}">${v}</option>`));
    }*/


    function popularFiltros() {
      const paisSel = $('#filterPais').val();
      const ciudadSel = $('#filterCiudad').val();
      const anioSel = $('#filterAnio').val();
      const catSel = $('#filterCategoria').val();

      const filtrado = allData.filter(d =>
        (!paisSel || d.pais === paisSel) &&
        (!ciudadSel || d.ciudad === ciudadSel) &&
        (!anioSel || d.anio === anioSel) &&
        (!catSel || d.categor√≠a === catSel)
      );

      const unique = (arr, key) => [...new Set(arr.map(d => d[key]).filter(Boolean))].sort();

      const actualizarCombo = (id, valores) => {
        const select = $(id);
        const valorActual = select.val();
        select.empty().append(`<option value="">Todos</option>`);
        valores.forEach(v => select.append(`<option value="${v}">${v}</option>`));
        if (valores.includes(valorActual)) select.val(valorActual); // conservar selecci√≥n si a√∫n es v√°lida
      };

      actualizarCombo('#filterPais', unique(filtrado, 'pais'));
      actualizarCombo('#filterCiudad', unique(filtrado, 'ciudad'));
      actualizarCombo('#filterAnio', unique(filtrado, 'anio'));
      actualizarCombo('#filterCategoria', unique(filtrado, 'categor√≠a'));
    }

    $('#filterPais, #filterCiudad, #filterAnio, #filterCategoria').on('change', function () {
      popularFiltros();        // actualizar opciones seg√∫n selecci√≥n
      aplicarFiltrosYGraficos(); // actualizar datos mostrados
    });


    function aplicarFiltrosYGraficos() {
      const pais = $('#filterPais').val();
      const ciudad = $('#filterCiudad').val();
      const anio = $('#filterAnio').val();
      const categoria = $('#filterCategoria').val();

      const filtrado = allData.filter(d =>
        (!pais || d.pais === pais) &&
        (!ciudad || d.ciudad === ciudad) &&
        (!anio || d.anio === anio) &&
        (!categoria || d.categor√≠a === categoria)
      );

      cargarTabla(filtrado);
      renderGraficos(filtrado);
    }

    function cargarTabla(data) {
      const tabla = $('#tablaDatos').DataTable();
      tabla.clear().destroy();
      const cuerpo = data.map(d => [
        d.orden, d.anio, d.mes, d.dia, d.fecha,
        d.pais, d.ciudad, d.categor√≠a, d.producto,
        d.precio, d.util_porcent, d.Cantidad, d.Total, d.utilidad
      ]);
      $('#tablaDatos').DataTable({
        data: cuerpo,
        columns: [
          { title: "Orden" },
          { title: "A√±o" },
          { title: "Mes" },
          { title: "D√≠a" },
          { title: "Fecha" },
          { title: "Pa√≠s" },
          { title: "Ciudad" },
          { title: "Categor√≠a" },
          { title: "Producto" },
          {
            title: "Precio",
            className: "text-end",
            render: function (data, type, row) {
              return parseFloat(data).toFixed(2);
            }
          },
          {
            title: "% Utilidad",
            className: "text-end",
            render: function (data, type, row) {
              return parseFloat(data).toFixed(2);
            }
          },
          {
            title: "Cantidad",
            className: "text-end",
            render: function (data, type, row) {
              return parseFloat(data).toFixed(2);
            }
          },
          {
            title: "Total",
            className: "text-end",
            render: function (data, type, row) {
              return parseFloat(data).toFixed(2);
            }
          },
          {
            title: "Utilidad",
            className: "text-end",
            render: function (data, type, row) {
              return parseFloat(data).toFixed(2);
            }
          }
        ],
        responsive: true
      });
    }

    function renderGraficos(data) {
      ['ventasPorPais', 'ventasPorCategoria', 'ventasPorFecha', 'graficoRadar', 'graficoDoughnut'].forEach(id => {
        Chart.getChart(id)?.destroy();
      });

      const ventasPais = {}, ventasCategoria = {}, ventasFecha = {}, radarData = {}, doughnutData = {};

      data.forEach(d => {
        const pais = d.pais;
        const cat = d.categor√≠a;
        const fecha = d.fecha;
        const ciudad = d.ciudad;
        const total = parseFloat(d.Total || 0);

        ventasPais[pais] = (ventasPais[pais] || 0) + total;
        ventasCategoria[cat] = (ventasCategoria[cat] || 0) + total;
        ventasFecha[fecha] = (ventasFecha[fecha] || 0) + total;
        radarData[ciudad] = (radarData[ciudad] || 0) + total;
        doughnutData[cat] = (doughnutData[cat] || 0) + total;
      });

      new Chart(document.getElementById('ventasPorPais'), {
        type: 'bar',
        data: {
          labels: Object.keys(ventasPais),
          datasets: [{
            label: 'Total de Ventas por Pa√≠s',
            data: Object.values(ventasPais),
            backgroundColor: 'rgb(255, 153, 0)'
          }]
        }
      });

      new Chart(document.getElementById('ventasPorCategoria'), {
        type: 'pie',
        data: {
          labels: Object.keys(ventasCategoria),
          datasets: [{
            label: 'Ventas por Categor√≠a',
            data: Object.values(ventasCategoria),
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
              '#C9CBCF', '#8E44AD', '#2ECC71', '#F39C12' // puedes agregar m√°s colores si hay m√°s categor√≠as
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Distribuci√≥n de Ventas por Categor√≠a',
              font: {
                size: 18
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.label || '';
                  let value = context.raw || 0;
                  let total = context.dataset.data.reduce((a, b) => a + b, 0);
                  let percentage = ((value / total) * 100).toFixed(2);
                  return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                }
              }
            },
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 20,
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });


      const fechasOrdenadas = Object.keys(ventasFecha).sort();
      new Chart(document.getElementById('ventasPorFecha'), {
        type: 'line',
        data: {
          labels: fechasOrdenadas,
          datasets: [{
            label: 'Ventas en el Tiempo',
            data: fechasOrdenadas.map(f => ventasFecha[f]),
            fill: false,
            borderColor: 'rgb(255, 102, 0)',
            tension: 0.1
          }]
        }
      });

      new Chart(document.getElementById('graficoRadar'), {
        type: 'radar',
        data: {
          labels: Object.keys(radarData),
          datasets: [{
            label: 'Ventas por Ciudad',
            data: Object.values(radarData),
            backgroundColor: 'rgb(255, 255, 153)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Ventas por Ciudad',
              font: {
                size: 18
              }
            }
          }
        }
      });

      new Chart(document.getElementById('graficoDoughnut'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(doughnutData),
          datasets: [{
            label: 'Distribuci√≥n por Categor√≠a',
            data: Object.values(doughnutData),
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
              '#C9CBCF', '#8E44AD', '#2ECC71', '#F39C12' // Colores adicionales por si hay m√°s categor√≠as
            ],
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          cutout: '60%', // Grosor del centro del doughnut (m√°s o menos hueco)
          plugins: {
            title: {
              display: true,
              text: 'Distribuci√≥n por Categor√≠a',
              font: {
                size: 18
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(2);
                  return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                }
              }
            },
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });


      $('#toggleTheme').on('click', function () {
        const html = document.documentElement;
        console.log(html);
        const isDark = html.getAttribute('data-bs-theme') === 'dark';
        html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
        this.textContent = isDark ? 'Modo Oscuro üåô' : 'Modo Claro ‚òÄÔ∏è ';

      });

    }
  </script>
</body>

</html>